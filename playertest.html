<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>player test — 测试播放器</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Segoe UI,Helvetica,Arial}
    #container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    video{max-width:100%;max-height:100%;width:100%;height:100%;background:#000;object-fit:contain;display:block}
    #overlay{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none}
    #controls{position:absolute;left:10px;top:10px;pointer-events:auto}
    #status{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:6px;font-size:13px}
    #loader{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:none}
    .spinner{width:44px;height:44px;border-radius:50%;border:4px solid rgba(255,255,255,0.12);border-top-color:#0af;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #help{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.5);padding:8px 10px;border-radius:6px;font-size:13px}
    #urlForm{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:6px}
    input[type=text]{width:360px;padding:6px;border-radius:4px;border:1px solid #333;background:#111;color:#fff}
    button{margin-left:6px;padding:6px 8px;border-radius:4px;border:0;background:#0af;color:#000;cursor:pointer}
    @media (max-width:480px){ input[type=text]{width:180px} }
  </style>
</head>
<body>
  <div id="container">
    <video id="video" controls playsinline controlsList="nodownload"></video>
    <div id="overlay">
      <div id="status">初始化…</div>
      <div id="loader"><div class="spinner" aria-hidden></div></div>
      <div id="controls"></div>
    </div>
  </div>

  <div id="urlForm">
    <label for="url">视频 URL:</label>
    <input id="url" type="text" placeholder="https://.../playlist.m3u8 或 https://.../video.mp4">
    <button id="loadBtn">加载并播放</button>
  </div>

  <div id="help">快捷键: Space 播放/暂停 · F 全屏 · M 静音 · ←/→ 快退/快进</div>

  <!-- 固定版本的 Hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
  <script>
    // 简单工具函数
    const $ = (s) => document.querySelector(s);
    const status = $('#status');
    const loader = $('#loader');
    const video = $('#video');
    const urlInput = $('#url');
    const loadBtn = $('#loadBtn');

    // 初始设置
    video.muted = true; // 允许静音 autoplay
    video.crossOrigin = 'anonymous';

    function showStatus(msg){ status.textContent = msg; }
    function showLoader(show){ loader.style.display = show ? 'block' : 'none'; }

    function isSupportedUrl(raw){
      if (!raw) return false;
      try {
        const u = new URL(raw);
        if (!['http:','https:'].includes(u.protocol)) return false;
        const p = u.pathname.toLowerCase();
        return p.endsWith('.m3u8') || p.endsWith('.mp4');
      } catch(e){ return false; }
    }

    function attachSource(rawUrl){
      showLoader(true);
      showStatus('正在准备播放...');
      const parsed = new URL(rawUrl);
      const path = parsed.pathname.toLowerCase();

      if (path.endsWith('.m3u8')){
        if (window.Hls && Hls.isSupported()){
          const hls = new Hls({
            maxBufferLength: 30
          });
          hls.loadSource(parsed.href);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            showLoader(false);
            showStatus('已加载 M3U8 流，尝试播放（静音）');
            video.play().catch(()=>{});
          });

          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS error', data);
            if (data && data.fatal){
              if (data.type === Hls.ErrorTypes.NETWORK_ERROR){
                showStatus('网络错误：无法加载流');
              } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR){
                showStatus('媒体错误，尝试恢复');
                hls.recoverMediaError();
              } else {
                showStatus('播放失败（HLS 错误）');
                hls.destroy();
              }
            } else {
              // 非致命错误
              showStatus('播放中（警告）');
            }
          });

        } else if (video.canPlayType('application/vnd.apple.mpegurl')){
          video.src = parsed.href;
          video.addEventListener('loadedmetadata', ()=>{ showLoader(false); showStatus('已加载，尝试播放（静音）'); video.play().catch(()=>{}); }, { once:true });
        } else {
          showLoader(false);
          showStatus('浏览器不支持 HLS（M3U8）');
        }

      } else if (path.endsWith('.mp4')){
        video.src = parsed.href;
        video.addEventListener('loadedmetadata', ()=>{ showLoader(false); showStatus('已加载 MP4，尝试播放（静音）'); video.play().catch(()=>{}); }, { once:true });
      } else {
        showLoader(false);
        showStatus('不支持的格式');
      }
    }

    // 首次用户交互：解除静音并尝试全屏（可选）
    function onFirstInteraction(){
      if (video.muted) video.muted = false;
      // 尝试进入全屏（如果用户期望）
      try{ if (video.requestFullscreen) video.requestFullscreen(); }catch(e){}
      window.removeEventListener('click', onFirstInteraction);
    }
    window.addEventListener('click', onFirstInteraction);

    // 键盘控制
    window.addEventListener('keydown', (e)=>{
      if (e.code === 'Space'){ e.preventDefault(); if(video.paused) video.play(); else video.pause(); }
      if (e.key.toLowerCase()==='f'){ if (document.fullscreenElement) document.exitFullscreen(); else video.requestFullscreen(); }
      if (e.key.toLowerCase()==='m'){ video.muted = !video.muted; showStatus(video.muted ? '静音' : '取消静音'); }
      if (e.key === 'ArrowRight'){ video.currentTime = Math.min(video.duration||0, video.currentTime + 10); }
      if (e.key === 'ArrowLeft'){ video.currentTime = Math.max(0, video.currentTime - 10); }
      if (e.key === 'ArrowUp'){ video.volume = Math.min(1, (video.volume||0.5) + 0.1); showStatus('音量: ' + Math.round(video.volume*100)); }
      if (e.key === 'ArrowDown'){ video.volume = Math.max(0, (video.volume||0.5) - 0.1); showStatus('音量: ' + Math.round(video.volume*100)); }
    });

    // 表单加载与 URL 参数支持（支持 ?url= 和 ?sub=）
    function getUrlParam(name){ try{ return new URL(location.href).searchParams.get(name); }catch(e){ return null; } }
    const initial = getUrlParam('url');
    const initialSub = getUrlParam('sub');
    if (initial){ urlInput.value = initial; }

    loadBtn.addEventListener('click', ()=>{
      const raw = urlInput.value.trim();
      if (!isSupportedUrl(raw)){
        alert('请输入有效的 http(s) 且以 .m3u8 或 .mp4 结尾的 URL');
        return;
      }
      attachSource(raw);
      // 如果有字幕参数
      const s = getUrlParam('sub');
      if (s){ const track = document.createElement('track'); track.kind='subtitles'; track.src = s; track.srclang='zh'; track.label='字幕'; track.default=true; video.appendChild(track); }
    });

    // 如果页面中带有 ?url= 则自动尝试加载（但保持静音）
    if (initial){ if (isSupportedUrl(initial)) attachSource(initial); else showStatus('URL 无效或不受支持'); }

    // 兼容性小提示
    showStatus('就绪：可粘贴 ?url= 或使用下方输入框加载流');
  </script>
</body>
</html>