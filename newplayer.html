<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>今晚看什么 - 播放器</title>
  <link rel="shortcut icon" href="https://jyjdsg.dpdns.org/favicon.ico">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #video-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    #video {
      width: 100%;
      height: 100%;
      display: block;
    }
    #error-msg {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 30px 40px;
      border-radius: 10px;
      font-size: 18px;
      text-align: center;
      z-index: 1000;
      display: none;
      max-width: 80%;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div id="video-container">
    <video 
      id="video" 
      controls 
      crossorigin="anonymous"
      controlsList="nodownload"
      style="width: 100%; height: 100%;"
    ></video>
  </div>
  <div id="error-msg"></div>

  <script src="https://unpkg.com/hls.js@latest/dist/hls.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const errorMsg = document.getElementById('error-msg');

    function showError(msg) {
      errorMsg.textContent = msg;
      errorMsg.style.display = 'block';
      console.error(msg);
    }

    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function getFileType(url) {
      try {
        const urlObj = new URL(url);
        const pathname = urlObj.pathname.toLowerCase();
        if (pathname.includes('.m3u8')) return 'm3u8';
        if (pathname.includes('.mp4')) return 'mp4';
        if (pathname.includes('.mkv')) return 'mkv';
        if (pathname.includes('.webm')) return 'webm';
        if (pathname.includes('.flv')) return 'flv';
        return 'mp4';
      } catch {
        return 'mp4';
      }
    }

    const videoUrl = getUrlParam('url');
    
    if (!videoUrl) {
      showError('请在网址后添加 URL 参数\n\n示例: ?url=https://example.com/video.mp4');
    } else {
      const fileType = getFileType(videoUrl);
      
      // 处理 HLS 流
      if (fileType === 'm3u8') {
        if (Hls.isSupported()) {
          const hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLevelLogger: null
          });
          
          hls.loadSource(videoUrl);
          hls.attachMedia(video);
          
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            console.log('HLS manifest parsed');
            video.play().catch(err => {
              console.warn('Autoplay failed:', err);
            });
          });
          
          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS Error:', data);
            if (data.fatal) {
              switch(data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  console.log('Network error, retrying...');
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  console.log('Media error, recovering...');
                  hls.recoverMediaError();
                  break;
                default:
                  showError('加载失败: ' + data.reason);
                  break;
              }
            }
          });
        } else {
          // 浏览器不支持 HLS，尝试直接播放
          video.src = videoUrl;
        }
      } else {
        // 直接播放 MP4 等格式
        video.src = videoUrl;
      }
      
      // 事件监听
      video.addEventListener('loadstart', () => {
        console.log('Video loading started');
      });
      
      video.addEventListener('canplay', () => {
        console.log('Video can play');
        errorMsg.style.display = 'none';
      });
      
      video.addEventListener('error', (e) => {
        const errorType = video.error?.code;
        const errorMsg1 = {
          1: '加载被中止',
          2: '网络错误',
          3: '解码失败',
          4: '不支持的格式'
        }[errorType] || '未知错误';
        showError('播放失败: ' + errorMsg1);
      });

      video.addEventListener('play', () => {
        console.log('Video playing');
      });

      // 键盘快捷键
      document.addEventListener('keydown', (e) => {
        if (!video) return;
        
        switch(e.key.toLowerCase()) {
          case 'f':
            e.preventDefault();
            if (document.fullscreenElement) {
              document.exitFullscreen();
            } else {
              video.requestFullscreen().catch(() => {});
            }
            break;
          case ' ':
            e.preventDefault();
            if (video.paused) {
              video.play();
            } else {
              video.pause();
            }
            break;
          case 'arrowright':
            video.currentTime += 10;
            break;
          case 'arrowleft':
            video.currentTime -= 10;
            break;
          case 'arrowup':
            e.preventDefault();
            video.volume = Math.min(1, video.volume + 0.1);
            break;
          case 'arrowdown':
            e.preventDefault();
            video.volume = Math.max(0, video.volume - 0.1);
            break;
          case 'm':
            video.muted = !video.muted;
            break;
        }
      });

      // 自动全屏（可选）
      // setTimeout(() => {
      //   video.requestFullscreen().catch(() => {});
      // }, 1000);
    }
  </script>
</body>
</html>
