<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€šç”¨åª’ä½“æ’­æ”¾å™¨</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¬</text></svg>">
  
  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  
  <!-- HLS.js for m3u8 support -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
  <!-- Video.js -->
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 
                   'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
      background: #000;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .container {
      width: 100vw;
      height: 100vh;
      background: #000;
      display: flex;
      flex-direction: column;
    }

    .player-container {
      flex: 1;
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    #video-player {
      width: 100%;
      height: 100%;
      background: #000;
    }

    /* Enhanced Video.js styling */
    .video-js {
      width: 100% !important;
      height: 100% !important;
      font-family: inherit;
    }

    .video-js .vjs-control-bar {
      background: linear-gradient(to top, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.7));
      height: 5em;
      display: flex;
      font-size: 16px;
    }

    .video-js .vjs-big-play-button {
      width: 3.5em;
      height: 3.5em;
      line-height: 3.5em;
      border-radius: 50%;
      background: rgba(0, 150, 255, 0.95);
      border: 4px solid rgba(255, 255, 255, 0.9);
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
      font-size: 2.5em;
    }

    .video-js .vjs-big-play-button:hover {
      background: #0096ff;
      transform: translate(-50%, -50%) scale(1.15);
      box-shadow: 0 0 40px rgba(0, 150, 255, 0.8);
    }

    .video-js .vjs-play-progress {
      background: linear-gradient(90deg, #0096ff, #00d4ff);
    }

    .video-js .vjs-volume-level {
      background: linear-gradient(90deg, #0096ff, #00d4ff);
    }

    .video-js .vjs-slider {
      background-color: rgba(255, 255, 255, 0.25);
    }

    .video-js .vjs-load-progress {
      background: rgba(255, 255, 255, 0.35);
    }

    .video-js .vjs-progress-control {
      position: absolute;
      bottom: 4.5em;
      width: 100%;
      height: 1em;
    }

    .video-js .vjs-progress-holder {
      height: 1em;
    }

    .video-js .vjs-play-progress::before {
      font-size: 1.2em;
      top: -0.5em;
    }

    .video-js .vjs-control:hover::before,
    .video-js .vjs-control:focus::before {
      color: #0096ff;
      text-shadow: 0 0 15px rgba(0, 150, 255, 0.8);
    }

    .video-js .vjs-time-control {
      min-width: 4em;
      padding: 0 0.8em;
      font-size: 1.2em;
      line-height: 5em;
    }

    .video-js .vjs-remaining-time {
      display: block;
    }

    .video-js .vjs-volume-panel {
      order: 3;
    }

    .video-js .vjs-playback-rate {
      order: 2;
      font-size: 1.1em;
    }

    .video-js .vjs-fullscreen-control {
      order: 4;
      font-size: 1.6em;
    }

    .video-js .vjs-button > .vjs-icon-placeholder:before {
      font-size: 2em;
      line-height: 2.5;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-top-color: #0096ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      color: #fff;
      font-size: 16px;
      font-weight: 500;
    }

    .error-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99;
      padding: 40px;
      text-align: center;
    }

    .error-overlay.show {
      display: flex;
    }

    .error-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .error-title {
      color: #fff;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .error-message {
      color: rgba(255, 255, 255, 0.7);
      font-size: 16px;
      line-height: 1.6;
      max-width: 600px;
    }

    .error-url {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      color: #0096ff;
      font-size: 14px;
      word-break: break-all;
      max-width: 800px;
    }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10000;
      border: 2px solid rgba(0, 150, 255, 0.5);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
    }

    .toast.show {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .video-js .vjs-control-bar {
        font-size: 14px;
        height: 4.5em;
      }

      .video-js .vjs-progress-control {
        bottom: 4em;
      }

      .video-js .vjs-big-play-button {
        font-size: 2em;
      }

      .error-title {
        font-size: 22px;
      }

      .error-message {
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="player-container">
      <video 
        id="video-player" 
        class="video-js vjs-big-play-centered" 
        controls 
        preload="auto"
        playsinline
        autoplay
      >
        <p class="vjs-no-js">
          è¦è§‚çœ‹æ­¤è§†é¢‘ï¼Œè¯·å¯ç”¨ JavaScript æˆ–å‡çº§åˆ°æ”¯æŒ HTML5 çš„æµè§ˆå™¨ã€‚
        </p>
      </video>

      <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨åŠ è½½è§†é¢‘...</div>
      </div>

      <div class="error-overlay" id="error-overlay">
        <div class="error-icon">âš ï¸</div>
        <div class="error-title">æ— æ³•åŠ è½½è§†é¢‘</div>
        <div class="error-message">
          è¯·æ£€æŸ¥è§†é¢‘åœ°å€æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…è¯¥æ ¼å¼æ˜¯å¦è¢«æ”¯æŒã€‚<br>
          ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ç½‘å€åæ·»åŠ  <strong>?url=è§†é¢‘åœ°å€</strong>
        </div>
        <div class="error-url" id="error-url"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // åˆå§‹åŒ–æ’­æ”¾å™¨
    const videoElement = document.getElementById('video-player');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorOverlay = document.getElementById('error-overlay');
    const errorUrlDisplay = document.getElementById('error-url');
    
    let player = videojs('video-player', {
      controls: true,
      autoplay: true,
      preload: 'auto',
      fluid: false,
      responsive: true,
      playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 2],
      controlBar: {
        children: [
          'playToggle',
          'currentTimeDisplay',
          'timeDivider',
          'durationDisplay',
          'progressControl',
          'remainingTimeDisplay',
          'volumePanel',
          'playbackRateMenuButton',
          'fullscreenToggle'
        ]
      }
    });

    let hlsInstance = null;

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message, duration = 2500) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(url) {
      loadingOverlay.classList.add('hidden');
      errorOverlay.classList.add('show');
      errorUrlDisplay.textContent = url || 'æœªæä¾›è§†é¢‘åœ°å€';
    }

    // éšè—åŠ è½½
    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // æ£€æµ‹è§†é¢‘æ ¼å¼
    function detectFormat(url) {
      const urlLower = url.toLowerCase();
      if (urlLower.includes('.m3u8') || urlLower.includes('m3u8')) {
        return 'M3U8';
      } else if (urlLower.includes('.mp4')) {
        return 'MP4';
      } else if (urlLower.includes('.webm')) {
        return 'WebM';
      } else if (urlLower.includes('.ogg') || urlLower.includes('.ogv')) {
        return 'OGG';
      } else if (urlLower.includes('.mov')) {
        return 'MOV';
      }
      return 'AUTO';
    }

    // åŠ è½½è§†é¢‘
    function loadVideo(url) {
      if (!url || url.trim() === '') {
        showError('');
        return;
      }

      console.log('Loading video:', url);

      // æ¸…ç†ä¹‹å‰çš„ HLS å®ä¾‹
      if (hlsInstance) {
        hlsInstance.destroy();
        hlsInstance = null;
      }

      const format = detectFormat(url);
      const isHLS = url.toLowerCase().includes('m3u8');

      try {
        if (isHLS) {
          // M3U8 æ ¼å¼ä½¿ç”¨ HLS.js
          if (Hls.isSupported()) {
            hlsInstance = new Hls({
              enableWorker: true,
              lowLatencyMode: true,
              backBufferLength: 90,
              maxBufferLength: 30,
              maxMaxBufferLength: 600
            });

            hlsInstance.loadSource(url);
            hlsInstance.attachMedia(videoElement);

            hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
              console.log('HLS manifest parsed');
              hideLoading();
              showToast('âœ… HLS æµåŠ è½½æˆåŠŸ');
              
              // è‡ªåŠ¨æ’­æ”¾
              const playPromise = videoElement.play();
              if (playPromise !== undefined) {
                playPromise.then(() => {
                  console.log('Auto-play started');
                }).catch(error => {
                  console.log('Auto-play prevented:', error);
                  showToast('â„¹ï¸ è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹è§‚çœ‹');
                });
              }
            });

            hlsInstance.on(Hls.Events.ERROR, function(event, data) {
              console.error('HLS Error:', data);
              if (data.fatal) {
                switch(data.type) {
                  case Hls.ErrorTypes.NETWORK_ERROR:
                    console.log('Network error, trying to recover...');
                    showToast('âŒ ç½‘ç»œé”™è¯¯ï¼Œå°è¯•æ¢å¤...');
                    hlsInstance.startLoad();
                    break;
                  case Hls.ErrorTypes.MEDIA_ERROR:
                    console.log('Media error, trying to recover...');
                    showToast('âŒ åª’ä½“é”™è¯¯ï¼Œå°è¯•æ¢å¤...');
                    hlsInstance.recoverMediaError();
                    break;
                  default:
                    showError(url);
                    showToast('âŒ æ— æ³•æ’­æ”¾æ­¤è§†é¢‘');
                    break;
                }
              }
            });

          } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari åŸç”Ÿæ”¯æŒ HLS
            videoElement.src = url;
            hideLoading();
            showToast('âœ… ä½¿ç”¨åŸç”Ÿ HLS æ”¯æŒ');
            
            videoElement.play().catch(error => {
              console.log('Auto-play prevented:', error);
              showToast('â„¹ï¸ è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹è§‚çœ‹');
            });
          } else {
            showError(url);
            showToast('âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾');
          }
        } else {
          // å…¶ä»–æ ¼å¼ç›´æ¥ä½¿ç”¨ HTML5 video
          videoElement.src = url;
          
          videoElement.addEventListener('loadeddata', function() {
            console.log('Video loaded');
            hideLoading();
            showToast('âœ… è§†é¢‘åŠ è½½æˆåŠŸ');
          }, { once: true });

          videoElement.addEventListener('canplay', function() {
            console.log('Video can play');
            videoElement.play().catch(error => {
              console.log('Auto-play prevented:', error);
              showToast('â„¹ï¸ è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹è§‚çœ‹');
            });
          }, { once: true });

          videoElement.addEventListener('error', function(e) {
            console.error('Video error:', e);
            showError(url);
            showToast('âŒ è§†é¢‘åŠ è½½å¤±è´¥');
          }, { once: true });
        }

      } catch (error) {
        console.error('Load error:', error);
        showError(url);
        showToast('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message);
      }
    }

    // ä» URL å‚æ•°è·å–è§†é¢‘åœ°å€å¹¶è‡ªåŠ¨æ’­æ”¾
    function autoLoadVideo() {
      const params = new URLSearchParams(window.location.search);
      const url = params.get('url');
      
      if (url) {
        const decodedUrl = decodeURIComponent(url);
        console.log('Auto-loading video from URL parameter:', decodedUrl);
        loadVideo(decodedUrl);
      } else {
        showError('');
        console.log('No URL parameter provided');
      }
    }

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      switch(e.key) {
        case ' ':
          e.preventDefault();
          if (videoElement.paused) {
            videoElement.play();
            showToast('â–¶ æ’­æ”¾');
          } else {
            videoElement.pause();
            showToast('â¸ æš‚åœ');
          }
          break;
        case 'ArrowLeft':
          e.preventDefault();
          videoElement.currentTime = Math.max(0, videoElement.currentTime - 5);
          showToast('âª å¿«é€€ 5ç§’');
          break;
        case 'ArrowRight':
          e.preventDefault();
          videoElement.currentTime = Math.min(videoElement.duration, videoElement.currentTime + 5);
          showToast('â© å¿«è¿› 5ç§’');
          break;
        case 'ArrowUp':
          e.preventDefault();
          videoElement.volume = Math.min(1, videoElement.volume + 0.1);
          showToast('ğŸ”Š éŸ³é‡: ' + Math.round(videoElement.volume * 100) + '%');
          break;
        case 'ArrowDown':
          e.preventDefault();
          videoElement.volume = Math.max(0, videoElement.volume - 0.1);
          showToast('ğŸ”‰ éŸ³é‡: ' + Math.round(videoElement.volume * 100) + '%');
          break;
        case 'f':
        case 'F':
          e.preventDefault();
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            showToast('â›¶ å…¨å±æ¨¡å¼');
          } else {
            document.exitFullscreen();
            showToast('â›¶ é€€å‡ºå…¨å±');
          }
          break;
        case 'm':
        case 'M':
          e.preventDefault();
          videoElement.muted = !videoElement.muted;
          showToast(videoElement.muted ? 'ğŸ”‡ é™éŸ³' : 'ğŸ”Š å–æ¶ˆé™éŸ³');
          break;
      }
    });

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ’­æ”¾
    window.addEventListener('DOMContentLoaded', autoLoadVideo);

  </script>
</body>
</html>
